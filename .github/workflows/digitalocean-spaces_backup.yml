name: Backup DigitalOcean Spaces to Local Server

on:
    workflow_dispatch:
# on:
#   schedule:
#     - cron: '0 2 * * *' # Запуск каждый день в 2:00
#   workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Backup DigitalOcean Spaces to Local Server
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.VPS_HOST }}
          port: ${{ secrets.SSH_PORT }}
          username: ${{ secrets.VPS_USERNAME }}
          password: ${{ secrets.VPS_PASSWORD }}
          script: |
            # Установка s3cmd если не установлен
            if ! command -v s3cmd &> /dev/null; then
              sudo apt-get update
              sudo apt-get install -y s3cmd
            fi

            # Конфигурация s3cmd с использованием переменных окружения
            cat <<EOF > ~/.s3cfg
            [default]
            access_key = ${{ secrets.AWS_ACCESS_KEY_ID }}
            secret_key = ${{ secrets.AWS_SECRET_ACCESS_KEY }}
            host_base = nyc3.digitaloceanspaces.com
            host_bucket = %(bucket)s.nyc3.digitaloceanspaces.com
            signature_v2 = False
            use_https = True
            EOF

            # Создание директории для бэкапов
            mkdir -p /home/${{ secrets.VPS_USERNAME }}/s3

            # Переменные окружения для бакетов
            BUCKETS=("ngdem-internal-public" "ngdem-stage-public")

            for BUCKET in "${BUCKETS[@]}"; do
              if s3cmd ls s3://$BUCKET &> /dev/null; then
                echo "Syncing $BUCKET..."
                s3cmd sync s3://$BUCKET/ /mnt/io-db-backups/s3/$BUCKET/
              else
                echo "Bucket $BUCKET does not exist."
              fi
            done

